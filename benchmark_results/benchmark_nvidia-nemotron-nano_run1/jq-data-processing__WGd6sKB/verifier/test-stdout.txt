Get:1 http://deb.debian.org/debian bookworm InRelease [151 kB]
Get:2 http://deb.debian.org/debian bookworm-updates InRelease [55.4 kB]
Get:3 http://deb.debian.org/debian-security bookworm-security InRelease [48.0 kB]
Get:4 http://deb.debian.org/debian bookworm/main amd64 Packages [8791 kB]
Get:5 http://deb.debian.org/debian bookworm-updates/main amd64 Packages [6924 B]
Get:6 http://deb.debian.org/debian-security bookworm-security/main amd64 Packages [290 kB]
Fetched 9342 kB in 1s (7867 kB/s)
Reading package lists...
Reading package lists...
Building dependency tree...
Reading state information...
The following additional packages will be installed:
  libbrotli1 libcurl4 libldap-2.5-0 libldap-common libnghttp2-14 libpsl5
  librtmp1 libsasl2-2 libsasl2-modules libsasl2-modules-db libssh2-1
  publicsuffix
Suggested packages:
  libsasl2-modules-gssapi-mit | libsasl2-modules-gssapi-heimdal
  libsasl2-modules-ldap libsasl2-modules-otp libsasl2-modules-sql
The following NEW packages will be installed:
  curl libbrotli1 libcurl4 libldap-2.5-0 libldap-common libnghttp2-14 libpsl5
  librtmp1 libsasl2-2 libsasl2-modules libsasl2-modules-db libssh2-1
  publicsuffix
0 upgraded, 13 newly installed, 0 to remove and 0 not upgraded.
Need to get 1839 kB of archives.
After this operation, 4550 kB of additional disk space will be used.
Get:1 http://deb.debian.org/debian bookworm/main amd64 libbrotli1 amd64 1.0.9-2+b6 [275 kB]
Get:2 http://deb.debian.org/debian bookworm/main amd64 libsasl2-modules-db amd64 2.1.28+dfsg-10 [20.3 kB]
Get:3 http://deb.debian.org/debian bookworm/main amd64 libsasl2-2 amd64 2.1.28+dfsg-10 [59.7 kB]
Get:4 http://deb.debian.org/debian bookworm/main amd64 libldap-2.5-0 amd64 2.5.13+dfsg-5 [183 kB]
Get:5 http://deb.debian.org/debian bookworm/main amd64 libnghttp2-14 amd64 1.52.0-1+deb12u2 [73.0 kB]
Get:6 http://deb.debian.org/debian bookworm/main amd64 libpsl5 amd64 0.21.2-1 [58.7 kB]
Get:7 http://deb.debian.org/debian bookworm/main amd64 librtmp1 amd64 2.4+20151223.gitfa8646d.1-2+b2 [60.8 kB]
Get:8 http://deb.debian.org/debian bookworm/main amd64 libssh2-1 amd64 1.10.0-3+b1 [179 kB]
Get:9 http://deb.debian.org/debian bookworm/main amd64 libcurl4 amd64 7.88.1-10+deb12u14 [392 kB]
Get:10 http://deb.debian.org/debian bookworm/main amd64 curl amd64 7.88.1-10+deb12u14 [316 kB]
Get:11 http://deb.debian.org/debian bookworm/main amd64 libldap-common all 2.5.13+dfsg-5 [29.3 kB]
Get:12 http://deb.debian.org/debian bookworm/main amd64 libsasl2-modules amd64 2.1.28+dfsg-10 [66.6 kB]
Get:13 http://deb.debian.org/debian bookworm/main amd64 publicsuffix all 20230209.2326-1 [126 kB]
Fetched 1839 kB in 0s (27.7 MB/s)
Selecting previously unselected package libbrotli1:amd64.
(Reading database ... (Reading database ... 5%(Reading database ... 10%(Reading database ... 15%(Reading database ... 20%(Reading database ... 25%(Reading database ... 30%(Reading database ... 35%(Reading database ... 40%(Reading database ... 45%(Reading database ... 50%(Reading database ... 55%(Reading database ... 60%(Reading database ... 65%(Reading database ... 70%(Reading database ... 75%(Reading database ... 80%(Reading database ... 85%(Reading database ... 90%(Reading database ... 95%(Reading database ... 100%(Reading database ... 7644 files and directories currently installed.)
Preparing to unpack .../00-libbrotli1_1.0.9-2+b6_amd64.deb ...
Unpacking libbrotli1:amd64 (1.0.9-2+b6) ...
Selecting previously unselected package libsasl2-modules-db:amd64.
Preparing to unpack .../01-libsasl2-modules-db_2.1.28+dfsg-10_amd64.deb ...
Unpacking libsasl2-modules-db:amd64 (2.1.28+dfsg-10) ...
Selecting previously unselected package libsasl2-2:amd64.
Preparing to unpack .../02-libsasl2-2_2.1.28+dfsg-10_amd64.deb ...
Unpacking libsasl2-2:amd64 (2.1.28+dfsg-10) ...
Selecting previously unselected package libldap-2.5-0:amd64.
Preparing to unpack .../03-libldap-2.5-0_2.5.13+dfsg-5_amd64.deb ...
Unpacking libldap-2.5-0:amd64 (2.5.13+dfsg-5) ...
Selecting previously unselected package libnghttp2-14:amd64.
Preparing to unpack .../04-libnghttp2-14_1.52.0-1+deb12u2_amd64.deb ...
Unpacking libnghttp2-14:amd64 (1.52.0-1+deb12u2) ...
Selecting previously unselected package libpsl5:amd64.
Preparing to unpack .../05-libpsl5_0.21.2-1_amd64.deb ...
Unpacking libpsl5:amd64 (0.21.2-1) ...
Selecting previously unselected package librtmp1:amd64.
Preparing to unpack .../06-librtmp1_2.4+20151223.gitfa8646d.1-2+b2_amd64.deb ...
Unpacking librtmp1:amd64 (2.4+20151223.gitfa8646d.1-2+b2) ...
Selecting previously unselected package libssh2-1:amd64.
Preparing to unpack .../07-libssh2-1_1.10.0-3+b1_amd64.deb ...
Unpacking libssh2-1:amd64 (1.10.0-3+b1) ...
Selecting previously unselected package libcurl4:amd64.
Preparing to unpack .../08-libcurl4_7.88.1-10+deb12u14_amd64.deb ...
Unpacking libcurl4:amd64 (7.88.1-10+deb12u14) ...
Selecting previously unselected package curl.
Preparing to unpack .../09-curl_7.88.1-10+deb12u14_amd64.deb ...
Unpacking curl (7.88.1-10+deb12u14) ...
Selecting previously unselected package libldap-common.
Preparing to unpack .../10-libldap-common_2.5.13+dfsg-5_all.deb ...
Unpacking libldap-common (2.5.13+dfsg-5) ...
Selecting previously unselected package libsasl2-modules:amd64.
Preparing to unpack .../11-libsasl2-modules_2.1.28+dfsg-10_amd64.deb ...
Unpacking libsasl2-modules:amd64 (2.1.28+dfsg-10) ...
Selecting previously unselected package publicsuffix.
Preparing to unpack .../12-publicsuffix_20230209.2326-1_all.deb ...
Unpacking publicsuffix (20230209.2326-1) ...
Setting up libpsl5:amd64 (0.21.2-1) ...
Setting up libbrotli1:amd64 (1.0.9-2+b6) ...
Setting up libsasl2-modules:amd64 (2.1.28+dfsg-10) ...
Setting up libnghttp2-14:amd64 (1.52.0-1+deb12u2) ...
Setting up libldap-common (2.5.13+dfsg-5) ...
Setting up libsasl2-modules-db:amd64 (2.1.28+dfsg-10) ...
Setting up librtmp1:amd64 (2.4+20151223.gitfa8646d.1-2+b2) ...
Setting up libsasl2-2:amd64 (2.1.28+dfsg-10) ...
Setting up libssh2-1:amd64 (1.10.0-3+b1) ...
Setting up publicsuffix (20230209.2326-1) ...
Setting up libldap-2.5-0:amd64 (2.5.13+dfsg-5) ...
Setting up libcurl4:amd64 (7.88.1-10+deb12u14) ...
Setting up curl (7.88.1-10+deb12u14) ...
Processing triggers for libc-bin (2.36-9+deb12u13) ...
Reading package lists...
Building dependency tree...
Reading state information...
Package jq is not available, but is referred to by another package.
This may mean that the package is missing, has been obsoleted, or
is only available from another source

Reading package lists...
Building dependency tree...
Reading state information...
yq is already the newest version (3.1.0-3).
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
no checksums to verify
installing to /root/.local/bin
  uv
  uvx
everything's installed!

To add $HOME/.local/bin to your PATH, either restart your shell or run:

    source $HOME/.local/bin/env (sh, bash, zsh)
    source $HOME/.local/bin/env.fish (fish)
============================= test session starts ==============================
platform linux -- Python 3.13.11, pytest-8.4.1, pluggy-1.6.0
rootdir: /tests
collected 14 items

../tests/test_outputs.py ..FFFFFFFFFF..                                  [100%]

=================================== FAILURES ===================================
_______________________ test_output_uses_correct_schema ________________________

    def test_output_uses_correct_schema():
        """Test that the output file uses the correct schema."""
        with open("/app/active_users_report.json", "r") as f:
            users = json.load(f)
    
        for user in users:
>           assert "user_id" in user, "Missing 'user_id' field"
E           AssertionError: Missing 'user_id' field
E           assert 'user_id' in {'email': 'jillrhodes@gmail.com', 'id': 1, 'last_login': '2025-04-03T19:43:31.386213Z', 'roles': ['admin', 'viewer'], ...}

/tests/test_outputs.py:33: AssertionError
_______________________ test_only_active_users_included ________________________

    def test_only_active_users_included():
        """Test that only active users are included in the output."""
        # Load the input data to check original statuses
        with open("/app/users.json", "r") as f:
            input_users = json.load(f)
    
        # Load the output data
        with open("/app/active_users_report.json", "r") as f:
            output_users = json.load(f)
    
        # Create a mapping of user IDs to their original status
        id_to_status = {user["id"]: user["status"] for user in input_users}
    
        # Check that all output users were active in the input
        for user in output_users:
>           user_id = user["user_id"]
                      ^^^^^^^^^^^^^^^
E           KeyError: 'user_id'

/tests/test_outputs.py:56: KeyError
____________________________ test_last_login_format ____________________________

    def test_last_login_format():
        """Test that last_login dates are formatted correctly (YYYY-MM-DD)."""
        with open("/app/active_users_report.json", "r") as f:
            users = json.load(f)
    
        for user in users:
            last_login = user["last_login"]
            try:
>               datetime.strptime(last_login, "%Y-%m-%d")

/tests/test_outputs.py:70: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.13/_strptime.py:789: in _strptime_datetime
    tt, fraction, gmtoff_fraction = _strptime(data_string, format)
                                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

data_string = '2025-04-03T19:43:31.386213Z', format = '%Y-%m-%d'

    def _strptime(data_string, format="%a %b %d %H:%M:%S %Y"):
        """Return a 2-tuple consisting of a time struct and an int containing
        the number of microseconds based on the input string and the
        format string."""
    
        for index, arg in enumerate([data_string, format]):
            if not isinstance(arg, str):
                msg = "strptime() argument {} must be str, not {}"
                raise TypeError(msg.format(index, type(arg)))
    
        global _TimeRE_cache, _regex_cache
        with _cache_lock:
            locale_time = _TimeRE_cache.locale_time
            if (_getlang() != locale_time.lang or
                time.tzname != locale_time.tzname or
                time.daylight != locale_time.daylight):
                _TimeRE_cache = TimeRE()
                _regex_cache.clear()
                locale_time = _TimeRE_cache.locale_time
            if len(_regex_cache) > _CACHE_MAX_SIZE:
                _regex_cache.clear()
            format_regex = _regex_cache.get(format)
            if not format_regex:
                try:
                    format_regex = _TimeRE_cache.compile(format)
                # KeyError raised when a bad format is found; can be specified as
                # \\, in which case it was a stray % but with a space after it
                except KeyError as err:
                    bad_directive = err.args[0]
                    del err
                    bad_directive = bad_directive.replace('\\s', '')
                    if not bad_directive:
                        raise ValueError("stray %% in format '%s'" % format) from None
                    bad_directive = bad_directive.replace('\\', '', 1)
                    raise ValueError("'%s' is a bad directive in format '%s'" %
                                        (bad_directive, format)) from None
                _regex_cache[format] = format_regex
        found = format_regex.match(data_string)
        if not found:
            raise ValueError("time data %r does not match format %r" %
                             (data_string, format))
        if len(data_string) != found.end():
>           raise ValueError("unconverted data remains: %s" %
                              data_string[found.end():])
E           ValueError: unconverted data remains: T19:43:31.386213Z

/usr/local/lib/python3.13/_strptime.py:558: ValueError

During handling of the above exception, another exception occurred:

    def test_last_login_format():
        """Test that last_login dates are formatted correctly (YYYY-MM-DD)."""
        with open("/app/active_users_report.json", "r") as f:
            users = json.load(f)
    
        for user in users:
            last_login = user["last_login"]
            try:
                datetime.strptime(last_login, "%Y-%m-%d")
            except ValueError:
>               pytest.fail(f"Invalid date format: {last_login}")
E               Failed: Invalid date format: 2025-04-03T19:43:31.386213Z

/tests/test_outputs.py:72: Failed
___________________________ test_role_count_correct ____________________________

    def test_role_count_correct():
        """Test that role_count correctly reflects the number of roles in the input."""
        # Load the input data to check original roles
        with open("/app/users.json", "r") as f:
            input_users = json.load(f)
    
        # Load the output data
        with open("/app/active_users_report.json", "r") as f:
            output_users = json.load(f)
    
        # Create a mapping of user IDs to their original roles
        id_to_roles = {user["id"]: user["roles"] for user in input_users}
    
        # Check that role_count matches the number of roles in the input
        for user in output_users:
>           user_id = user["user_id"]
                      ^^^^^^^^^^^^^^^
E           KeyError: 'user_id'

/tests/test_outputs.py:90: KeyError
__________________________ test_primary_role_correct ___________________________

    def test_primary_role_correct():
        """Test that primary_role is the first role from the input roles array."""
        # Load the input data to check original roles
        with open("/app/users.json", "r") as f:
            input_users = json.load(f)
    
        # Load the output data
        with open("/app/active_users_report.json", "r") as f:
            output_users = json.load(f)
    
        # Create a mapping of user IDs to their original roles
        id_to_roles = {user["id"]: user["roles"] for user in input_users}
    
        # Check that primary_role is correct
        for user in output_users:
>           user_id = user["user_id"]
                      ^^^^^^^^^^^^^^^
E           KeyError: 'user_id'

/tests/test_outputs.py:112: KeyError
____________________________ test_users_are_sorted _____________________________

    def test_users_are_sorted():
        """Test that users are sorted alphabetically by username."""
        with open("/app/active_users_report.json", "r") as f:
            users = json.load(f)
    
        usernames = [user["username"] for user in users]
>       assert usernames == sorted(usernames), "Users are not sorted by username"
E       AssertionError: Users are not sorted by username
E       assert ['johnsonjosh...icholas', ...] == ['abrown', 'a...entracy', ...]
E         
E         At index 0 diff: 'johnsonjoshua' != 'abrown'
E         Use -v to get more diff

/tests/test_outputs.py:131: AssertionError
_______________________ test_output_is_pretty_formatted ________________________

    def test_output_is_pretty_formatted():
        """Test that the output JSON is pretty-printed with 2-space indentation."""
        with open("/app/active_users_report.json", "r") as f:
            content = f.read()
    
        # Check the first few lines for proper indentation
        lines = content.splitlines()
        if len(lines) > 1:
            line = lines[0]
            assert len(line) - len(line.lstrip()) == 0, (
                f"Line '{line}' has incorrect indentation"
            )
            line = lines[-1]
            assert len(line) - len(line.lstrip()) == 0, (
                f"Line '{line}' has incorrect indentation"
            )
            # Skip line (array start)
            for line in lines[1:-1]:
                if line.strip():  # Skip empty lines
                    indentation = len(line) - len(line.lstrip())
                    if line.strip() == "{" or line.strip() == "}," or line.strip() == "}":
                        assert indentation == 2, f"Line '{line}' has incorrect indentation"
                    else:
>                       assert indentation == 4, f"Line '{line}' has incorrect indentation"
E                       AssertionError: Line '      "admin",' has incorrect indentation
E                       assert 6 == 4

/tests/test_outputs.py:157: AssertionError
_______________________________ test_jq_was_used _______________________________

    def test_jq_was_used():
        """Test that jq was used to generate the output and validate the command."""
        # 1. Check if cmd.sh exists
>       assert os.path.exists("/app/cmd.sh"), "Command file cmd.sh not found"
E       AssertionError: Command file cmd.sh not found
E       assert False
E        +  where False = <function exists at 0x764b66a12980>('/app/cmd.sh')
E        +    where <function exists at 0x764b66a12980> = <module 'posixpath' (frozen)>.exists
E        +      where <module 'posixpath' (frozen)> = os.path

/tests/test_outputs.py:163: AssertionError
___________________________ test_jq_args_yaml_exists ___________________________

    def test_jq_args_yaml_exists():
        """Test that the jq_args.yaml file was created successfully."""
>       assert os.path.exists("/app/jq_args.yaml"), "YAML args file jq_args.yaml not found"
E       AssertionError: YAML args file jq_args.yaml not found
E       assert False
E        +  where False = <function exists at 0x764b66a12980>('/app/jq_args.yaml')
E        +    where <function exists at 0x764b66a12980> = <module 'posixpath' (frozen)>.exists
E        +      where <module 'posixpath' (frozen)> = os.path

/tests/test_outputs.py:211: AssertionError
__________________________ test_jq_args_yaml_is_valid __________________________

    def test_jq_args_yaml_is_valid():
        """Test that the jq_args.yaml file contains valid YAML with required keys."""
    
        # 1. Check if jq_args.yaml exists
>       assert os.path.exists("/app/jq_args.yaml"), "YAML args file jq_args.yaml not found"
E       AssertionError: YAML args file jq_args.yaml not found
E       assert False
E        +  where False = <function exists at 0x764b66a12980>('/app/jq_args.yaml')
E        +    where <function exists at 0x764b66a12980> = <module 'posixpath' (frozen)>.exists
E        +      where <module 'posixpath' (frozen)> = os.path

/tests/test_outputs.py:218: AssertionError
==================================== PASSES ====================================
=========================== short test summary info ============================
PASSED ../tests/test_outputs.py::test_output_file_exists
PASSED ../tests/test_outputs.py::test_output_is_valid_json
PASSED ../tests/test_outputs.py::test_jq_args_yaml_produces_same_output
PASSED ../tests/test_outputs.py::test_input_file_hash_unchanged
FAILED ../tests/test_outputs.py::test_output_uses_correct_schema - AssertionE...
FAILED ../tests/test_outputs.py::test_only_active_users_included - KeyError: ...
FAILED ../tests/test_outputs.py::test_last_login_format - Failed: Invalid dat...
FAILED ../tests/test_outputs.py::test_role_count_correct - KeyError: 'user_id'
FAILED ../tests/test_outputs.py::test_primary_role_correct - KeyError: 'user_id'
FAILED ../tests/test_outputs.py::test_users_are_sorted - AssertionError: User...
FAILED ../tests/test_outputs.py::test_output_is_pretty_formatted - AssertionE...
FAILED ../tests/test_outputs.py::test_jq_was_used - AssertionError: Command f...
FAILED ../tests/test_outputs.py::test_jq_args_yaml_exists - AssertionError: Y...
FAILED ../tests/test_outputs.py::test_jq_args_yaml_is_valid - AssertionError:...
========================= 10 failed, 4 passed in 0.36s =========================
